<!doctype html><html lang=en><head><title>Running Arch on the TI Nspire CX Calculator :: null pointer</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This is a follow up to my previous post on how to run Debian on the Nspire, this time we will be going deeper into the matter and compiling the Linux Kernel ourselves, and doing such in a way that it&amp;rsquo;s compatible with Arch Linux ARM
Hardware requirements The requirements for this project are the same as for the last one, here&amp;rsquo;s what you&amp;rsquo;ll need:
A Texas TI Nspire CX or CX CAS USB Hub Mini-B OTG USB Cable USB Drive Setting everything up Since we will be building the Kernel ourselves this time we will need to do some special work on our setup, in particular to our build environment."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/arch-on-the-nspire/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/assets/green.css><link rel=apple-touch-icon href=/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=/images/favicon.png><meta name=twitter:card content="summary"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Running Arch on the TI Nspire CX Calculator"><meta property="og:description" content="This is a follow up to my previous post on how to run Debian on the Nspire, this time we will be going deeper into the matter and compiling the Linux Kernel ourselves, and doing such in a way that it&amp;rsquo;s compatible with Arch Linux ARM
Hardware requirements The requirements for this project are the same as for the last one, here&amp;rsquo;s what you&amp;rsquo;ll need:
A Texas TI Nspire CX or CX CAS USB Hub Mini-B OTG USB Cable USB Drive Setting everything up Since we will be building the Kernel ourselves this time we will need to do some special work on our setup, in particular to our build environment."><meta property="og:url" content="/posts/arch-on-the-nspire/"><meta property="og:site_name" content="null pointer"><meta property="og:image" content="/images/favicon.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:section" content="tutorial"><meta property="article:published_time" content="2016-10-28 00:00:00 +0000 UTC"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>null pointer</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=/posts/arch-on-the-nspire/>Running Arch on the TI Nspire CX Calculator</a></h1><div class=post-meta><span class=post-date>2016-10-28</span></div><span class=post-tags>#<a href=/tags/linux/>linux</a>&nbsp;
#<a href=/tags/ti/>ti</a>&nbsp;
#<a href=/tags/arm/>arm</a>&nbsp;
#<a href=/tags/calculator/>calculator</a>&nbsp;</span><div class=post-content><div><p>This is a follow up to my previous post on how to run Debian on the Nspire,
this time we will be going deeper into the matter and compiling the Linux Kernel
ourselves, and doing such in a way that it&rsquo;s compatible with
<a href=archlinuxarm.org>Arch Linux ARM</a></p><h2 id=hardware-requirements>Hardware requirements<a href=#hardware-requirements class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The requirements for this project are the same as for the
<a href=/post/2016-05-30-debian-on-the-nspire>last one</a>, here&rsquo;s what you&rsquo;ll need:</p><ul><li>A Texas TI Nspire CX or CX CAS</li><li>USB Hub</li><li>Mini-B OTG USB Cable</li><li>USB Drive</li></ul><h2 id=setting-everything-up>Setting everything up<a href=#setting-everything-up class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Since we will be building the Kernel ourselves this time we will need to do some
special work on our setup, in particular to our build environment.</p><h3 id=cross-compiling>Cross Compiling<a href=#cross-compiling class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Firstly, we must get a cross-compiler working, in this case an <code>arm-none-eabi</code>
type compiler, there&rsquo;s a caveat though, in order for the Kernel to work with
the Nspire we must build it on an outdated toolchain. There is a good tutorial
over on <a href=https://github.com/ndless-nspire/Ndless/wiki/Ndless-SDK:-C-and-assembly-development-introduction>Ndless SDK</a> on how to do that, but we will be going over
the steps here.</p><ol><li><p>Clone the SDK</p><ul><li><code>git clone --recursive https://github.com/ndless-nspire/Ndless.git</code></li></ul></li><li><p>Run the <code>ndless-sdk/toolchain/build_toolchain.sh</code> script.</p><ul><li>This will download the toolchain as well as build it for you. It will
take a while.<figure class=left><img src=./images/compiling.jpg><figcaption class=center>Compiling is tough on the CPU</figcaption></figure></li></ul></li><li><p>The original guide recommends adding the binaries&rsquo; path to your <code>PATH</code>, but
since I don&rsquo;t think that amending your <code>.bashrc</code> for one-time projects like
these is worth it, and having to manually edit your path can be boring,
I have created this <a href=./files/setpath.sh><code>bash</code> script</a>
that does that. Place it inside the <code>Ndless</code> folder, and then source it
(make sure your current work path is the <code>Ndless</code> folder too, i.e. <code>cd</code>
into it).</p></li><li><p>Your cross-compiler should be working now. Test it by running
<code>arm-none-eabi-gcc</code> and see if you get any output.<figure class=left><img src=./images/xcompiler.jpg><figcaption class=center>You should get output like this</figcaption></figure></p></li></ol><p>If you managed to produce output in step 4. that means your Cross Compiler is
working well. Remember to source that file whenever you want to use the
binaries you compiled, or add them to your <code>PATH</code> on <code>.bashrc</code> if you think
you might be using them often.</p><h4 id=getting-the-kernel>Getting the kernel<a href=#getting-the-kernel class=hanchor arialabel=Anchor>&#8983;</a></h4><p>Every kernel compilation starts with a configuration file, this one is no
different. Since setting the configuration so that it works on the Nspire is a
hassle, I have set up <a href=https://github.com/lovesegfault/nspire-kernel>a repository</a> that will contain
configurations for different versions of the Linux kernel. At the time of
writing, solely <code>4.3.0</code> is there, but work on other versions is ongoing. Feel
free to contact me if you&rsquo;d like a config for a version of the kernel not yet
supported. For the rest of this guide we will be using Kernel <code>4.3.0</code>, although
nothing should change for future versions.</p><ol><li><p>Download the Linux kernel and untar it</p><ul><li><a href=https://www.kernel.org/pub/linux/kernel/v4.x/linux-4.3.tar.xz><code>linux-4.3.tar.xz</code></a></li></ul></li><li><p>Clone the configurations repository</p><ul><li><code>git clone https://github.com/lovesegfault/nspire-kernel</code></li></ul></li><li><p>Copy the configuration file to the kernel folder, name it .config</p><ul><li><code>cp nspire-kernel/4.3.0/config linux-4.3/.config</code></li></ul></li></ol><figure class=left><img src=./images/config.jpg><figcaption class=center>You should be able to get output like this</figcaption></figure><p>With this your kernel is ready for compilation, don&rsquo;t worry, we will get to it
in a moment.</p><h2 id=compiling-the-kernel>Compiling the kernel<a href=#compiling-the-kernel class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Now that we have set up all the pieces that we will need for the
compilation, we can start it. Make sure you have your .config file in the right
place. Also confirm that you have the toolchain we compiled in your <code>PATH</code>.</p><ol><li><p><code>ARCH=arm make -jX</code></p><ul><li><code>ARCH=arm</code> specifies the architecture we&rsquo;re building to</li><li><code>-jX</code> parallelizes compilation. Replace <code>X</code> with your thread count.<figure class=left><img src=./images/linux-compiling.jpg><figcaption class=center>Compiling the kernel, get yourself a cup of coffee</figcaption></figure></li></ul></li><li><p>Check that you have the following files</p><ul><li><code>arch/arm/boot/zImage</code></li><li><code>arch/arm/boot/dts/cx.dtb</code></li></ul></li></ol><p>The compilation step is now complete. We have built our kernel image (<code>zImage</code>)
and out device tree file (<code>nspire-cx.dtb</code>) which are the files we needed.</p><h2 id=preparing-the-system-drive>Preparing the system drive<a href=#preparing-the-system-drive class=hanchor arialabel=Anchor>&#8983;</a></h2><p>In my last post we set op our rootfs using debian tools, this time it will
be a bit different. Up until now this guide was distro-independent, apart
from the fact that the config file is heavily influence by arch linux&rsquo;s one,
but we must shift this perspective now to focus on the subject of this post:
Arch Linux. For the rest of this project we will be using <a href=archlinuxarm.org>ALARM</a>, the
Arch Linux port for the ARM architecture.</p><h3 id=getting-the-files>Getting the files<a href=#getting-the-files class=hanchor arialabel=Anchor>&#8983;</a></h3><ol><li><p>Download the latest version of ALARM for ARMv5</p><ul><li><a href=http://os.archlinuxarm.org/os/ArchLinuxARM-armv5-latest.tar.gz>http://os.archlinuxarm.org/os/ArchLinuxARM-armv5-latest.tar.gz</a></li></ul></li><li><p>Make sure your USB drive uses an MBR partition table</p></li><li><p>Format the drive. Add some SWAP space, it will be useful for doing more
memory-hungry operations.</p><ul><li>I&rsquo;m using 512MiB Swap space on my drive, reason for which is the fact
that my drive is small at 8GB.</li></ul></li><li><p>Untar the file you downloaded into the drive</p><ul><li><code>sudo bsdtar xzf ArchLinuxARM-armv5-latest.tar.gz -C ~/mnt/</code>
Replace <code>~/mnt</code> with wherever you mounted your drive.<figure class=left><img src=./images/rootfs.jpg><figcaption class=center>Your rootfs should look like this</figcaption></figure></li></ul></li></ol><h3 id=installing-modules>Installing modules<a href=#installing-modules class=hanchor arialabel=Anchor>&#8983;</a></h3><ol><li><p><code>cd</code> into the directory where we compiled linux</p></li><li><p>Make sure the <code>arm-none-eabi</code> toolchain is in your <code>PATH</code></p></li><li><p>Install modules to the USB drive</p><ul><li><code>sudo ARCH=arm make modules_install INSTALL_MOD_PATH=~/mnt/</code></li></ul></li></ol><figure class=left><img src=./images/modules.jpg><figcaption class=center>Modules installed</figcaption></figure><h3 id=changing-root-with-qemu>Changing root with QEMU<a href=#changing-root-with-qemu class=hanchor arialabel=Anchor>&#8983;</a></h3><ol><li><p>Make sure you have <code>qemu-user-static</code> and <code>binfmt-support</code> installed.</p></li><li><p>Copy QEMU binaries to the drive: <code>sudo cp /usr/bin/qemu-arm-static ~/mnt/usr/bin</code></p></li><li><p>Register <code>qemu-arm-static</code> as an ARM interpreter in the kernel (must be
root)</p><ul><li><script type=application/javascript src=https://gist.github.com/lovesegfault/eded4fe8ef2fb88bfa1e08529e2cb6ca.js></script></li></ul></li><li><p>Change root into the new rootfs. If you are running arch and you have the
<code>arch-install-scripts</code> package installed you can use <code>arch-chroot</code></p></li><li><p>Synchronize package databases <code>pacman -Syy</code></p></li><li><p>At this point you might want to install some recommended packages, such as
<code>sudo</code>. If you have a USB WiFi Adapter connected to your hub you should
also consider installing <code>dialog</code> and <code>wpa_supplicant</code></p></li></ol><h3 id=downgrading-the-kernel>Downgrading the kernel<a href=#downgrading-the-kernel class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Since we are using an outdated kernel version, <code>4.3.0</code>, relative to the one
on the ALARM image we extracted we must downgrade the kernel. Firstly you will
need a kernel package. You can download the ones I compiled
(<a href=./files/linux-armv5-4.3.0-1-arm.pkg.tar.xz><code>linux-armv5-4.3.0-1-arm.pkg.tar.xz</code></a> and
<a href=./files/linux-armv5-headers-4.3.0-1-arm.pkg.tar.xz><code>linux-armv5-headers-4.3.0-1-arm.pkg.tar.xz</code></a>) and install
from the <code>chroot</code> with <code>pacman -U [FILES]</code>, or compile it yourself. You can do
that with either <a href=https://wiki.archlinux.org/index.php/Distcc><code>distcc</code></a> (recommended) or with the following steps:</p><ol><li><p>Clone the ALARM <a href=https://github.com/archlinuxarm/PKGBUILDs/>PKGBUILD repository</a></p></li><li><p>Roll it back to commit <code>c82145d0d491c2e216ff49ec60d3e83c13e73230</code></p><ul><li><code>git reset --hard c82145d0d491c2e216ff49ec60d3e83c13e73230</code></li></ul></li><li><p>Copy the <code>core/linux-armv5</code> folder somewhere else</p></li><li><p>Replace the <code>config</code> file in the folder with our own</p></li><li><p>Get an MD5Sum of our config file</p></li><li><p>Replace the MD5Sum on the <code>PKGBUILD</code> file with out new one, it&rsquo;s the last
one in the list.</p></li><li><p><code>makepkg -cs --install</code></p></li></ol><figure class=left><img src=./images/downgrade.jpg><figcaption class=center>Downgrade in progress</figcaption></figure><p>Whichever way you choose, you can check if it worked by:</p><ul><li>Running <code>ls /lib/modules</code> and seeing if you see the correct module folder
there.</li><li>Running <code>pacman -Qs</code> and checking if it lists the kernel as version
<code>4.3.0-1</code></li></ul><figure class=left><img src=./images/check-downgrade.jpg><figcaption class=center>Downgrade successful</figcaption></figure><p>Lastly, add the packages <code>linux-armv5</code> and <code>linux-armv5-headers</code> to your ignore
list over on <code>/etc/pacman.conf</code>. To do so, uncomment the <code>IgnorePkg</code> line, and
add them, separated by spaces, to it. This will guarantee that these changes
won&rsquo;t be later overwritten by some system upgrade.</p><h3 id=setting-up-the-calculator>Setting up the calculator<a href=#setting-up-the-calculator class=hanchor arialabel=Anchor>&#8983;</a></h3><p>To run the bootloader for the Linux kernel you will need to
<a href=http://ndless.me/>jailbreak</a> your calculator. There are a lot of good online tutorials on
how to do this, I, for one, recommend the guide from <a href=https://tiplanet.org/forum/ndl3ss.php>TIPlanet</a>.
With that out of the way we can get to setting up the files on the calculator&rsquo;s
flash memory.</p><ol><li><p>Download the <a href=./files/linuxloader2.tns>bootloader</a></p></li><li><p>Download the <a href=./files/start_usb.ll2.tns>starting script</a></p></li><li><p><code>cd</code> into the folder containing Linux, where we performed the compilation
steps.</p></li><li><p>Copy <code>arch/arm/boot/zImage</code> and <code>arch/arm/boot/dts/cx.dtb</code> somewhere</p></li><li><p>Concatenate the <code>.tns</code> extension to both of them</p></li></ol><p>Since the TI Connectivity software does not work on Linux at all (not even
under Wine), you will require either a Windows or MacOS machine to get
files to and from your calculator, Virtual Machines work.</p><ol><li><p>Edit the <code>ndless.cfg.tns</code> file and append <code>ext.ll2 linuxloader2</code> to it.</p><ul><li>This associates our starting script to the bootloader program</li></ul></li><li><p>Create a folder named <code>linux</code></p></li><li><p>Place the files you downloaded, <code>zImage.tns</code>, and <code>nspire-cx.dtb.tns</code> into
the <code>linux</code> folder</p></li></ol><figure class=left><img src=./images/files.jpg><figcaption class=center>Files on the calculator</figcaption></figure><h3 id=finishing-up>Finishing up<a href=#finishing-up class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Once the files have been placed on the calculator, the process is done. You may now
start the OS by executing the bootloader. If you have any questions on how to
do this you can reference the <a href=/post/2016-05-30-debian-on-the-nspire>initial article</a>. Below is a
demo video of the calculator playing Doom on Linux.</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/O3eSspki0Ws style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/on-leibniz-truth/><span class=button__icon>←</span>
<span class=button__text>On Leibniz's Truth</span></a></span>
<span class="button next"><a href=/posts/debian-on-the-nspire/><span class=button__text>Running Debian on the TI Nspire CX Calculator</span>
<span class=button__icon>→</span></a></span></div></div><script src=https://utteranc.es/client.js repo=lovesegfault/blog issue-term=title theme=github-dark crossorigin=anonymous async></script></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Copyright &copy; 2021 - Bernardo Meurer</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script>
<script>window.WebFontConfig={custom:{families:["KaTeX_AMS","KaTeX_Caligraphic:n4,n7","KaTeX_Fraktur:n4,n7","KaTeX_Main:n4,n7,i4,i7","KaTeX_Math:i4,i7","KaTeX_Script","KaTeX_SansSerif:n4,n7,i4","KaTeX_Size1","KaTeX_Size2","KaTeX_Size3","KaTeX_Size4","KaTeX_Typewriter"]}}</script><script defer src=https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.js integrity="sha256-4O4pS1SH31ZqrSO2A/2QJTVjTPqVe+jnYgOWUVr7EEc=" crossorigin=anonymous></script><link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css integrity=sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc crossorigin=anonymous as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css integrity=sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc crossorigin=anonymous></noscript><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.js integrity=sha384-YNHdsYkH6gMx9y3mRkmcJ2mFUjTd0qNQQvY9VYZgQd7DcN7env35GzlmFaZ23JGp crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous onload=renderMathInElement(document.body)></script></div></body></html>